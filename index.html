<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Buntes 3D Racing ‚Äì Mobile + Highscore + Skybox</title>
  <style>
    html, body { height: 100%; margin: 0; background:#000; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto; overflow:hidden; }
    #hud { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,.6); padding: 10px 14px; border-radius: 16px; font-weight: 600; line-height:1.6; box-shadow: 0 0 20px rgba(255,255,255,.4); z-index: 10; }
    #hud .big { font-size: 20px; }
    #hud .small { font-size: 12px; opacity:.85; }
    #tips { position: fixed; right: 12px; bottom: 12px; background: rgba(0,0,0,.6); border-radius: 14px; padding: 10px 14px; font-size: 12px; line-height:1.5; box-shadow:0 0 15px magenta; z-index: 10; }
    #banner { position: fixed; inset: 0; display:none; place-items:center; background: rgba(0,0,0,.7); color:#fff; font-size: clamp(22px, 4vw, 42px); font-weight:800; text-align:center; z-index: 20; }
    #banner .card { background: rgba(0,0,0,.6); padding: 28px 34px; border-radius: 20px; box-shadow:0 0 25px cyan; }
    #banner button { margin-top: 14px; font-size: 16px; padding: 10px 16px; border-radius: 12px; border: none; background: linear-gradient(45deg, magenta, cyan); color:#fff; cursor: pointer; }

    /* Mobile controls */
    #mobile { position: fixed; left: 50%; transform: translateX(-50%); bottom: 16px; display:none; gap: 18px; z-index: 15; align-items: center; }
    .btn { width: 70px; height: 70px; border-radius: 18px; border: none; background: linear-gradient(135deg, #ff0, #f0f, #0ff); color:#000; font-weight:900; font-size: 20px; display:grid; place-items:center; box-shadow:0 0 20px rgba(255,255,255,.5); user-select:none; -webkit-user-select:none; touch-action:none; }
    .btn:active { transform: scale(.98); }
    #mobile .col { display:flex; gap:18px; }

    canvas { display:block; width:100vw; height:100vh; }
  </style>
</head>
<body>
  <div id="hud">
    <div class="big" id="speed">0 km/h</div>
    <div><span class="small">Runde</span> <span id="lap">1</span>/<span id="lapMax">3</span></div>
    <div><span class="small">Zeit</span> <span id="time">0.00</span>s</div>
    <div><span class="small">Best-Lap</span> <span id="best">‚Äì</span></div>
    <div><span class="small">Rekord (Total)</span> <span id="record">‚Äì</span></div>
  </div>
  <div id="tips">Desktop: ‚Üê/‚Üí oder A/D ‚Ä¢ ‚Üë/‚Üì Gas/Bremse ‚Ä¢ P Pause ‚Ä¢ R Neustart ‚Äî Mobil: Buttons unten</div>
  <div id="banner"><div class="card"><div id="bannerText">Pause</div><button id="restart">Neustart</button></div></div>

  <div id="mobile">
    <div class="col">
      <button class="btn" id="left">‚óÄ</button>
      <button class="btn" id="right">‚ñ∂</button>
    </div>
    <div class="col">
      <button class="btn" id="brake">‚ñ†</button>
      <button class="btn" id="gas">‚ñ≤</button>
    </div>
  </div>

  <canvas id="game"></canvas>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.157.0/build/three.module.js';

    // -------- Renderer & Scene --------
    const canvas = document.getElementById('game');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
    renderer.setPixelRatio(Math.min(devicePixelRatio,2));
    renderer.setSize(innerWidth,innerHeight);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1200);

    // -------- Skybox / Skydome --------
    function makeSkyTexture(size=1024){
      const c=document.createElement('canvas'); c.width=c.height=size; const g=c.getContext('2d');
      // radial gradient (nebula-ish)
      const rad=g.createRadialGradient(size*0.5,size*0.6,size*0.1, size*0.5,size*0.5,size*0.7);
      rad.addColorStop(0,'#1a0033');
      rad.addColorStop(0.4,'#26004d');
      rad.addColorStop(0.75,'#001a33');
      rad.addColorStop(1,'#000010');
      g.fillStyle=rad; g.fillRect(0,0,size,size);
      // stars
      for(let i=0;i<2000;i++){
        const x=Math.random()*size, y=Math.random()*size; const r=Math.random()*1.6; 
        g.fillStyle=`hsla(${Math.floor(Math.random()*360)},100%,70%,${0.6+Math.random()*0.4})`;
        g.beginPath(); g.arc(x,y,r,0,Math.PI*2); g.fill();
      }
      return new THREE.CanvasTexture(c);
    }
    const skyMat = new THREE.MeshBasicMaterial({ map: makeSkyTexture(1024), side: THREE.BackSide });
    const sky = new THREE.Mesh(new THREE.SphereGeometry(1000, 48, 32), skyMat);
    scene.add(sky);

    // -------- Lights --------
    const hemi = new THREE.HemisphereLight(0xff00ff, 0x00ffff, 0.7); scene.add(hemi);
    const dir = new THREE.PointLight(0xffffff, 1.1, 300); dir.position.set(0,20,20); scene.add(dir);

    // -------- Track --------
    const ROAD_WIDTH = 14;
    const SEG_LEN = 40;
    const SEG_COUNT = 18;

    const roadGroup = new THREE.Group();
    scene.add(roadGroup);

    function makeSegment(){
      const group = new THREE.Group();
      const geo = new THREE.PlaneGeometry(ROAD_WIDTH, SEG_LEN);
      const mat = new THREE.MeshStandardMaterial({ color: new THREE.Color().setHSL(Math.random(),1,0.55), emissive: new THREE.Color().setHSL(Math.random(),1,0.55), emissiveIntensity:0.85, roughness:.8 });
      const road = new THREE.Mesh(geo, mat);
      road.rotation.x = -Math.PI/2;
      group.add(road);
      return group;
    }
    const segments=[];
    for(let i=0;i<SEG_COUNT;i++){
      const s=makeSegment();
      s.position.z=-i*SEG_LEN;
      roadGroup.add(s);
      segments.push(s);
    }

    // -------- Car --------
    const car = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(2.2,1,4.2), new THREE.MeshStandardMaterial({color:0xffff00, emissive:0xff00ff, emissiveIntensity:1.0}));
    body.position.y=0.7;
    const cabin = new THREE.Mesh(new THREE.BoxGeometry(1.6,.8,1.6), new THREE.MeshStandardMaterial({color:0x00ffff, emissive:0x00ff00, emissiveIntensity:1.0}));
    cabin.position.set(0,1.1,-0.4);
    car.add(body,cabin);
    scene.add(car);

    function placeCamera(){
      camera.position.copy(car.position).add(new THREE.Vector3(0,6,9));
      camera.lookAt(car.position.x,car.position.y+0.6,car.position.z-6);
    }

    // -------- Obstacles --------
    const obstacles=[];
    function makeObstacle(){
      const m = new THREE.Mesh(new THREE.BoxGeometry(1.5,1,1.5), new THREE.MeshStandardMaterial({color:new THREE.Color().setHSL(Math.random(),1,0.5), emissive:new THREE.Color().setHSL(Math.random(),1,0.5), emissiveIntensity:0.95}));
      m.position.y=0.5; return m;
    }
    function populateObstacles(){
      obstacles.length=0;
      segments.forEach((seg,idx)=>{
        if(idx<3) return;
        if(Math.random()<0.65){
          const o=makeObstacle();
          o.position.set((Math.random()-0.5)*ROAD_WIDTH*0.6,0.5,seg.position.z-Math.random()*SEG_LEN);
          scene.add(o); obstacles.push(o);
        }
      });
    }
    populateObstacles();

    // -------- UI & State --------
    const ui={ speed:document.getElementById('speed'), lap:document.getElementById('lap'), lapMax:document.getElementById('lapMax'), time:document.getElementById('time'), best:document.getElementById('best'), record:document.getElementById('record'), banner:document.getElementById('banner'), bannerText:document.getElementById('bannerText'), restart:document.getElementById('restart'), mobile:document.getElementById('mobile'), left:document.getElementById('left'), right:document.getElementById('right'), brake:document.getElementById('brake'), gas:document.getElementById('gas') };

    const state={ speed:0,maxSpeed:160/3.6,accel:42/3.6,brake:75/3.6, steer:0, steerAccel:22, steerFriction:11, xClamp:ROAD_WIDTH*0.5-1.2, distance:0, lapLen:650, lap:1, lapMax:3, running:true, crashed:false, lastLapT:null, bestLap:null, raceStart:null, bestTotal: null };
    ui.lapMax.textContent=state.lapMax;

    // Highscore from localStorage
    try{
      const storedTotal = localStorage.getItem('racing_best_total');
      const storedLap = localStorage.getItem('racing_best_lap');
      if(storedTotal) state.bestTotal = parseFloat(storedTotal);
      if(storedLap) state.bestLap = parseFloat(storedLap);
    }catch{}
    function fmt(t){ return t? t.toFixed(2)+'s' : '‚Äì'; }
    ui.record.textContent = fmt(state.bestTotal);
    ui.best.textContent = fmt(state.bestLap);

    // Input
    const keys=new Set();
    window.addEventListener('keydown',e=>{ if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','a','d','w','s',' '].includes(e.key)) e.preventDefault(); if(e.key==='p'||e.key==='P'){togglePause();return;} if(e.key==='r'||e.key==='R'){restart();return;} keys.add(e.key); });
    window.addEventListener('keyup',e=>{ keys.delete(e.key); });

    // Mobile buttons (press & hold)
    const isMobile = matchMedia('(max-width: 900px)').matches || ('ontouchstart' in window);
    if(isMobile) ui.mobile.style.display='flex';
    let leftHeld=false, rightHeld=false, brakeHeld=false, gasHeld=false;
    function hold(btn, set){ const on=()=>set(true), off=()=>set(false); btn.addEventListener('pointerdown',e=>{e.preventDefault(); on();}); window.addEventListener('pointerup',off); window.addEventListener('pointercancel',off); btn.addEventListener('touchstart', e=> e.preventDefault(), {passive:false}); }
    hold(ui.left, v=> leftHeld=v); hold(ui.right, v=> rightHeld=v); hold(ui.brake, v=> brakeHeld=v); hold(ui.gas, v=> gasHeld=v);

    function togglePause(){ state.running=!state.running; ui.banner.style.display=state.running?'none':'grid'; ui.bannerText.textContent='Pause'; }
    function restart(){
      state.speed=0; state.distance=0; state.lap=1; state.crashed=false; state.running=true; state.lastLapT=null; state.raceStart=performance.now();
      car.position.set(0,0,4); car.rotation.set(0,0,0);
      segments.forEach((s,i)=> s.position.z=-i*SEG_LEN);
      obstacles.forEach(o=> scene.remove(o)); populateObstacles();
      ui.banner.style.display='none';
    }
    ui.restart.addEventListener('click',restart);

    const tmpBoxCar=new THREE.Box3(); const tmpBoxObs=new THREE.Box3();
    function carBox(){ return tmpBoxCar.setFromObject(car).expandByScalar(-0.2); }

    function updateHUD(){
      ui.speed.textContent=Math.round(state.speed*3.6)+' km/h';
      ui.lap.textContent=state.lap;
      if(state.lastLapT===null) state.lastLapT=performance.now();
      const t=(performance.now()-state.lastLapT)/1000;
      ui.time.textContent=t.toFixed(2);
      ui.best.textContent=fmt(state.bestLap);
      ui.record.textContent=fmt(state.bestTotal);
    }

    function saveHighscores(){
      try{
        if(state.bestTotal!=null) localStorage.setItem('racing_best_total', String(state.bestTotal));
        if(state.bestLap!=null) localStorage.setItem('racing_best_lap', String(state.bestLap));
      }catch{}
    }

    function endRace(){
      state.running=false;
      const total = (performance.now() - state.raceStart)/1000;
      if(!state.bestTotal || total < state.bestTotal) state.bestTotal = total;
      saveHighscores();
      ui.banner.style.display='grid'; ui.bannerText.textContent = `Ziel! üéâ\nGesamt: ${total.toFixed(2)}s`;
    }
    function crash(){ if(state.crashed) return; state.crashed=true; state.running=false; ui.banner.style.display='grid'; ui.bannerText.textContent='Crash! üí•'; }

    // -------- Loop --------
    let last=performance.now();
    restart(); // set raceStart

    function tick(){
      const now=performance.now(); let dt=Math.min(0.033,(now-last)/1000); last=now;

      // sky slow rotation
      sky.rotation.y += dt*0.02;

      // Controls
      let up = keys.has('ArrowUp')||keys.has('w')||gasHeld;
      let down = keys.has('ArrowDown')||keys.has('s')||brakeHeld;
      let left = keys.has('ArrowLeft')||keys.has('a')||leftHeld;
      let right = keys.has('ArrowRight')||keys.has('d')||rightHeld;

      if(state.running){
        if(up) state.speed+=state.accel*dt; if(down) state.speed-=state.brake*dt; state.speed=THREE.MathUtils.clamp(state.speed,0,state.maxSpeed);
        const forward=state.speed*dt;
        if(left) state.steer-=state.steerAccel*dt; if(right) state.steer+=state.steerAccel*dt;
        const sgn=Math.sign(state.steer); state.steer-=sgn*Math.min(Math.abs(state.steer),state.steerFriction*dt);
        car.position.x+=state.steer*dt; car.position.x=THREE.MathUtils.clamp(car.position.x,-state.xClamp,state.xClamp);

        // move/recycle world
        segments.forEach(s=>{ s.position.z+=forward; if(s.position.z>SEG_LEN*2){ s.position.z-=SEG_COUNT*SEG_LEN; s.children[0].material.color.setHSL(Math.random(),1,0.55); s.children[0].material.emissive.setHSL(Math.random(),1,0.55);} });
        obstacles.forEach(o=>{ o.position.z+=forward; if(o.position.z>8){ o.position.z-=SEG_COUNT*SEG_LEN+Math.random()*SEG_LEN; o.material.color.setHSL(Math.random(),1,0.5); o.material.emissive.setHSL(Math.random(),1,0.5); } });

        // laps
        state.distance+=forward; if(state.distance>=state.lapLen){ state.distance-=state.lapLen; const lapTime=(performance.now()-state.lastLapT)/1000; if(!state.bestLap||lapTime<state.bestLap) state.bestLap=lapTime; state.lastLapT=performance.now(); state.lap+=1; if(state.lap>state.lapMax) endRace(); }

        // collisions
        const cbox=carBox(); for(let o of obstacles){ tmpBoxObs.setFromObject(o); if(cbox.intersectsBox(tmpBoxObs)){ crash(); break; } }

        car.rotation.z=THREE.MathUtils.damp(car.rotation.z,state.steer*0.03,6,dt);
        car.position.z=4; placeCamera();
      }

      updateHUD();
      renderer.render(scene,camera);
      requestAnimationFrame(tick);
    }

    function onResize(){ const w=innerWidth,h=innerHeight; renderer.setSize(w,h); camera.aspect=w/h; camera.updateProjectionMatrix(); }
    addEventListener('resize',onResize);

    requestAnimationFrame(tick);
  </script>
</body>
</html>
